#!/bin/bash
depends_on zlib

## don't use https to download openssl source because openssl might be too old to even establish a connection!
fetch_source http://security.debian.org/debian-security/pool/updates/main/o/openssl/openssl_1.0.1k.orig.tar.gz 19d818e202558c212a9583fcdaf876995a633ddf
fetch_debian http://security.debian.org/debian-security/pool/updates/main/o/openssl/openssl_1.0.1k-3+deb8u1.debian.tar.xz db5b45d90bf9d20e3e94161c96efe5fcaec5bbc3
fetch_file   http://curl.haxx.se/ca/cacert.pem ecf8b8f6b31edf0e376b7e3b3a95f2d4e7b41c2d # as of 2015-09-07

BUILDCONF=gcc
cc_addflags EXTRAFLAGS -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2 -Wl,-z,relro -Wa,--noexecstack -Wall -fno-strict-aliasing
cc_addflag EXTRAFLAGS -march=native -march=i686
SSLCONFIG="no-ssl2 no-ssl3 threads zlib --openssldir=$PREFIX/etc/ssl"

[[ $OSTYPE == *linux* ]] && [[ $HOSTTYPE == i?86 ]] && BUILDCONF=linux-elf
[[ $OSTYPE == *linux* ]] && [[ $HOSTTYPE == x86_64 ]] && BUILDCONF=debian-amd64 && SSLCONFIG="$SSLCONFIG enable-ec_nistp_64_gcc_128"
[[ $OSTYPE == *darwin* ]] && BUILDCONF=darwin64-x86_64-cc

do_undebian

fix_makefile() {
    sed -i "s:^CFLAG=.*\$:& $EXTRAFLAGS:" Makefile || false
}

pushd_src

## make both static and shared versions
log "Configuring static openssl"
./Configure no-shared --prefix=$PREFIX $LDFLAGS $SSLCONFIG $BUILDCONF
fix_makefile
NOPARALLEL=1 do_make all
!is_without tests && NOPARALLEL=1 do_make test
mv apps/openssl apps/openssl.static
mv libcrypto.a libcrypto.static
mv libssl.a libssl.static
do_make -f Makefile clean
log "Configuring shared openssl"
./Configure shared --prefix=$PREFIX $LDFLAGS $SSLCONFIG $BUILDCONF
fix_makefile
NOPARALLEL=1 do_make all
!is_without tests && NOPARALLEL=1 do_make test
do_install MANDIR=$PREFIX/share/man
mkdir -p $PREFIX/lib $PREFIX/bin
install -p -m755 apps/openssl.static $PREFIX/bin/openssl
install -p -m644 libcrypto.static $PREFIX/lib/libcrypto.a
install -p -m644 libssl.static $PREFIX/lib/libssl.a
popd

## install root certificates so curl and others can use HTTPS
mkdir -p $PREFIX/etc/ssl/certs
install -m 644 "$TARDIR/cacert.pem" "$PREFIX/etc/ssl/cert.pem"
