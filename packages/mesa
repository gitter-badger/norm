#!/bin/bash

requires_gcc 4.2

depends_on libdrm
depends_on libx11
depends_on libxext
depends_on libxdamage
depends_on libxshmfence

DISABLE_GALLIUM=
is_without gallium && DISABLE_GALLIUM="--with-gallium-drivers="

if [ -z "$DISABLE_GALLIUM" ]; then
    if ! test_cc_value "fcntl.h" "O_CLOEXEC"; then
        DISABLE_GALLIUM="--with-gallium-drivers="
        add_caveat "gallium in mesa was disabled -- your libc headers are too old."
    fi
fi

if [ -z "$DISABLE_GALLIUM" ]; then
    if have_gcc 4.7; then
        depends_on libllvm
    else
        DISABLE_GALLIUM="--with-gallium-drivers="
        add_caveat "You don't have GCC 4.7 or newer -- gallium in mesa was disabled."
    fi
fi

fetch_source ftp://ftp.freedesktop.org/pub/mesa/10.6.6/mesa-10.6.6.tar.xz 243d64853782013a20e6fecc56a6fae35f23ef6a

do_unpack

do_patch mesa-10.6.6-llvm_3_7-1.patch ## fix API changes introduced by libllvm 3.7

do_compile $DISABLE_GALLIUM \
                  --enable-gles1 \
                  --enable-gles2 \
                  --enable-osmesa \
                  --enable-xa \
                  --enable-glx-tls \
                  --enable-gbm \
                  --enable-sysfs \
                  --enable-texture-float
